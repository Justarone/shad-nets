## Структура проекта

есть 3 вспомогательных баш-скрипта:
* setup.sh - настроить окружение
* cleanup.sh - снести окружение
* run.sh - запустить mtr

при установке себе, можно запустить setup.sh и run.sh и заработает на конфигурации по умолчанию

основной скрипт поделен на 2 модуля:
1. core.py - реализует логику трассировки пути и сбора статистики
2. impl.py - позволяет "собрать" клиента в зависимости от конфигурации 3 (ipv4, ipv6) и 4 (icmp, tcp, udp (dns/raw)) уровней
3. `__main__.py` - объединяет модули и содержит main

## Принципы работы и нетривиальные моменты

каждый раз алгоритм идет с возрастанием по ttl до момента, когда перестанет получать icmp-ttl-exceeded, поэтому путь может меняться и могут меняться адреса на промежуточных хопах.

статистика собирается по хопам - если в какой-то момент пакет пойдет по другому пути, то для определенного хопа может появиться несколько адресов, при этом пути не "мержатся" (как это можно было бы делать с помощью какого-нибудь подобия расстояния Левенштейна).

таймаут ожидания по умолчанию - 2 секунды. все запросы выполняются последовательно, поэтому если на пути порядка 5 точек не будут отвечать, то суммарное время ожидания будет > 10 секунд.

для ipv6 были некоторые сложности - домашний роутер не давал мне ipv6 адрес, а с локальным адресом сходить не получалось. проблема решилась сменой сети, в которой роутер выдает ipv6 (https://en.wikipedia.org/wiki/DHCPv6 + https://blogs.infoblox.com/ipv6-coe/why-you-must-use-icmpv6-router-advertisements-ras/)

для udp были сложности, так как для udp нет syn/syn-ack, нет возможности сделать своего рода "probe" на какой-то хост+порт, поэтому я попробовал слушать трафик для всяких стриминговых платформ, затем воспроизводить запросы по адресу и порту, но другой конец не отвечал на полупустые хаотичные запросы, поэтому я сделал 2 решения: (1) сделал свой эхо-сервер на удаленной машине, (2) сформировал валидные dns запросы.

## Конфигурации и результаты запуска

путем полного перебора (ipv4/ipv6 + udp/tcp/icmp) получается 6 конфигураций

### IPv4

#### UDP

конфигурация (dns):
```json
{
    "algorithm": {
        "target_address": "8.8.8.8"
    },
    "sender": {
        "l4": "udp",
        "l3": "ipv4"
    }
}
```

результат:
```
+------+------+---------+---------+---------+---------+-------------------------+
| hops | sent |  lost % |  avg ms |  min ms |  max ms |        addresses        |
+------+------+---------+---------+---------+---------+-------------------------+
|  1   |  11  |  0.00%  |  67.58  |  48.72  |  94.35  |      172.28.127.254     |
|  2   |  11  |  0.00%  |  72.79  |  55.65  |  100.30 |      90.156.176.254     |
|  3   |  11  | 100.00% | 2057.64 | 2047.19 | 2072.00 |         unknown         |
|  4   |  11  |  0.00%  |  72.21  |  60.03  |  88.93  |      212.188.6.252      |
|  5   |  11  |  0.00%  |  67.93  |  51.80  |  88.01  |      195.34.36.219      |
|  6   |  11  |  0.00%  |  77.46  |  51.78  |  99.89  |      142.251.68.215     |
|  7   |  11  |  0.00%  |  67.53  |  52.26  |  107.83 |     108.170.250.113     |
|  8   |  11  |  9.09%  |  266.95 |  71.79  | 2060.35 | 142.251.49.158, unknown |
|  9   |  11  |  0.00%  |  88.66  |  51.94  |  203.89 |      74.125.253.94      |
|  10  |  11  |  0.00%  |  80.66  |  67.62  |  99.53  |      216.239.46.139     |
|  11  |  11  | 100.00% | 2058.16 | 2043.84 | 2075.97 |         unknown         |
|  12  |  11  | 100.00% | 2058.70 | 2032.10 | 2076.02 |         unknown         |
|  13  |  11  | 100.00% | 2054.82 | 2036.43 | 2067.88 |         unknown         |
|  14  |  11  | 100.00% | 2062.16 | 2047.95 | 2111.86 |         unknown         |
|  15  |  11  | 100.00% | 2061.44 | 2047.77 | 2076.20 |         unknown         |
|  16  |  11  | 100.00% | 2064.07 | 2043.87 | 2091.65 |         unknown         |
|  17  |  11  | 100.00% | 2065.39 | 2051.77 | 2115.67 |         unknown         |
|  18  |  11  | 100.00% | 2054.91 | 2039.74 | 2072.32 |         unknown         |
|  19  |  11  | 100.00% | 2062.98 | 2044.20 | 2079.88 |         unknown         |
|  20  |  11  |  9.09%  |  79.76  |  55.88  |  108.23 |     unknown, 8.8.8.8    |
|  21  |  1   | 100.00% |  135.91 |  135.91 |  135.91 |         unknown         |
|  22  |  1   |  0.00%  |  67.95  |  67.95  |  67.95  |         8.8.8.8         |
+------+------+---------+---------+---------+---------+-------------------------+
```

примечание: видно, как в одной из попыток нам потребовалось на 2 хопа больше, поэтому 8.8.8.8 есть в 2 hops.

#### TCP

конфигурация:
```json
{
    "algorithm": {
        "target_address": "5.255.255.242"
    },
    "sender": {
        "l4": "tcp",
        "l3": "ipv4",
        "port": 443
    }
}
```

результат:
```
+------+------+---------+---------+---------+---------+----------------------------------------+
| hops | sent |  lost % |  avg ms |  min ms |  max ms |               addresses                |
+------+------+---------+---------+---------+---------+----------------------------------------+
|  1   |  13  |  0.00%  |  68.41  |  47.42  |  93.44  |              172.20.10.1               |
|  2   |  13  |  0.00%  |  108.37 |  68.21  |  135.82 |              172.16.9.66               |
|  3   |  13  |  0.00%  |  94.14  |  59.99  |  148.02 |              172.16.13.93              |
|  4   |  13  |  0.00%  |  108.85 |  87.71  |  196.08 |             195.34.36.225              |
|  5   |  13  |  61.54% | 1294.46 |  56.30  | 2056.00 |        212.188.28.148, unknown         |
|  6   |  13  |  30.77% |  703.03 |  72.09  | 2059.93 |        unknown, 212.188.28.151         |
|  7   |  13  |  0.00%  |  106.55 |  64.14  |  148.15 |             212.188.56.14              |
|  8   |  13  |  23.08% |  553.18 |  75.87  | 2075.73 |         212.188.55.2, unknown          |
|  9   |  13  |  0.00%  |  109.25 |  72.05  |  260.11 |             212.188.55.22              |
|  10  |  13  | 100.00% | 2058.08 | 2043.73 | 2067.96 |                unknown                 |
|  11  |  13  |  15.38% |  404.99 |  84.16  | 2059.81 |         unknown, 212.188.56.13         |
|  12  |  13  |  0.00%  |  112.65 |  72.01  |  196.01 |             212.188.33.199             |
|  13  |  13  |  84.62% | 1722.03 |  95.90  | 2067.86 | 93.158.160.113, 93.158.172.23, unknown |
|  14  |  13  | 100.00% | 1907.68 |  123.97 | 2072.02 |                unknown                 |
|  15  |  13  | 100.00% | 1937.87 |  500.09 | 2080.06 |                unknown                 |
|  16  |  13  | 100.00% | 1914.41 |  175.91 | 2084.01 |                unknown                 |
|  17  |  13  | 100.00% | 1907.40 |  99.93  | 2111.86 |                unknown                 |
|  18  |  13  | 100.00% | 1916.93 |  164.14 | 2143.89 |                unknown                 |
|  19  |  13  | 100.00% | 1999.96 | 1324.03 | 2071.89 |                unknown                 |
|  20  |  13  | 100.00% | 1909.82 |  127.87 | 2083.97 |                unknown                 |
|  21  |  13  | 100.00% | 1915.40 |  144.06 | 2084.13 |                unknown                 |
|  22  |  13  |  15.38% |  408.11 |  72.05  | 2063.97 |         5.255.255.242, unknown         |
|  23  |  2   |  0.00%  |  106.19 |  80.19  |  132.19 |             5.255.255.242              |
+------+------+---------+---------+---------+---------+----------------------------------------+
```

#### ICMP

конфигурация:
```json
{
    "algorithm": {
        "target_address": "5.255.255.242"
    },
    "sender": {
        "l4": "icmp",
        "l3": "ipv4"
    }
}
```

результат:
```
+------+------+--------+--------+--------+--------+----------------+
| hops | sent | lost % | avg ms | min ms | max ms |   addresses    |
+------+------+--------+--------+--------+--------+----------------+
|  1   |  20  | 0.00%  | 63.19  | 26.73  | 90.13  | 172.28.127.254 |
|  2   |  20  | 0.00%  | 68.53  | 52.07  | 84.17  |  5.255.237.42  |
|  3   |  20  | 0.00%  | 73.83  | 56.01  | 100.57 |   10.20.98.1   |
|  4   |  20  | 0.00%  | 71.26  | 47.75  | 92.23  |   10.2.1.254   |
|  5   |  20  | 0.00%  | 68.63  | 48.04  | 100.02 |    10.3.6.1    |
|  6   |  20  | 0.00%  | 67.00  | 48.50  | 88.67  | 5.255.255.242  |
+------+------+--------+--------+--------+--------+----------------+
```

### IPv6

#### ICMP

конфигурация:
```json
{
    "algorithm": {
        "target_address": "2a02:6b8::2:242"
    },
    "sender": {
        "l4": "icmp",
        "l3": "ipv6"
    }
}
```

результат:
```
+------+------+---------+---------+---------+---------+-------------------------+
| hops | sent |  lost % |  avg ms |  min ms |  max ms |        addresses        |
+------+------+---------+---------+---------+---------+-------------------------+
|  1   |  10  |  0.00%  |  71.21  |  51.39  |  94.19  |    2a02:6b8:0:40c::1    |
|  2   |  10  |  0.00%  |  69.69  |  47.74  |  87.71  |    2a02:6b8:0:475::c1   |
|  3   |  10  |  0.00%  |  69.65  |  43.43  |  87.92  |  2a02:6b8:0:2000::a501  |
|  4   |  10  |  0.00%  |  68.95  |  51.44  |  128.45 |  2a02:6b8:0:3400::deca  |
|  5   |  10  |  0.00%  |  72.79  |  43.92  |  103.61 |   2001:4860:1:1::19e9   |
|  6   |  10  |  0.00%  |  78.52  |  64.07  |  107.74 |   2001:4860:1:1::19e8   |
|  7   |  10  |  0.00%  |  82.87  |  55.90  |  108.81 | 2a00:1450:8000:288::1:1 |
|  8   |  10  |  0.00%  |  75.60  |  63.99  |  103.72 |   2001:4860:0:1::25a2   |
|  9   |  10  |  0.00%  |  75.93  |  47.60  |  99.73  |   2001:4860:0:116f::3   |
|  10  |  10  |  0.00%  |  82.08  |  63.76  |  112.54 |  2001:4860::c:4001:8e2d |
|  11  |  10  |  0.00%  |  89.49  |  79.72  |  103.76 | 2001:4860::cc:4001:23bc |
|  12  |  10  | 100.00% | 2059.10 | 2039.88 | 2079.84 |         unknown         |
|  13  |  10  | 100.00% | 2060.30 | 2039.44 | 2072.24 |         unknown         |
|  14  |  10  | 100.00% | 2064.85 | 2047.99 | 2080.09 |         unknown         |
|  15  |  10  | 100.00% | 2065.24 | 2043.99 | 2084.55 |         unknown         |
|  16  |  10  | 100.00% | 2062.25 | 2047.83 | 2080.40 |         unknown         |
|  17  |  10  | 100.00% | 2051.31 | 2039.73 | 2064.48 |         unknown         |
|  18  |  10  | 100.00% | 2058.33 | 2043.60 | 2072.28 |         unknown         |
|  19  |  10  | 100.00% | 2060.53 | 2047.79 | 2068.41 |         unknown         |
|  20  |  10  | 100.00% | 2060.32 | 2047.58 | 2072.64 |         unknown         |
|  21  |  10  |  0.00%  |  75.74  |  59.98  |  92.16  |   2001:4860:4860::8888  |
+------+------+---------+---------+---------+---------+-------------------------+
```

#### TCP

конфигурация:
```json
{
    "algorithm": {
        "target_address": "2001:4860:4860::8888"
    },
    "sender": {
        "l4": "tcp",
        "l3": "ipv6",
        "port": 443
    }
}
```

результат:
```
+------+------+---------+---------+---------+---------+-------------------------------+
| hops | sent |  lost % |  avg ms |  min ms |  max ms |           addresses           |
+------+------+---------+---------+---------+---------+-------------------------------+
|  1   |  11  |  0.00%  |  63.60  |  47.92  |  81.81  |       2a02:6b8:0:40c::1       |
|  2   |  11  |  0.00%  |  67.98  |  47.48  |  84.27  |       2a02:6b8:0:475::c1      |
|  3   |  11  |  0.00%  |  73.46  |  56.14  |  96.26  |     2a02:6b8:0:2000::a501     |
|  4   |  11  |  0.00%  |  74.57  |  60.12  |  107.89 |     2a02:6b8:0:3400::deca     |
|  5   |  11  |  0.00%  |  66.87  |  39.73  |  87.62  |      2001:4860:1:1::19e9      |
|  6   |  11  |  45.45% |  965.49 |  60.13  | 2079.92 |  2001:4860:1:1::19e8, unknown |
|  7   |  11  |  0.00%  |  83.10  |  63.96  |  99.79  |    2a00:1450:8000:29d::1:1    |
|  8   |  11  |  0.00%  |  80.83  |  52.40  |  96.33  |      2001:4860:0:1::31ba      |
|  9   |  11  |  36.36% |  716.13 |  71.95  | 2084.08 | 2001:4860:0:116f::11, unknown |
|  10  |  11  |  0.00%  |  83.55  |  67.80  |  103.93 |     2001:4860::8:4000:e5bd    |
|  11  |  11  |  0.00%  |  81.14  |  64.10  |  104.35 |    2001:4860::cc:4001:23bc    |
|  12  |  11  | 100.00% | 2059.58 | 2047.57 | 2072.25 |            unknown            |
|  13  |  11  | 100.00% | 2056.30 | 2036.10 | 2076.61 |            unknown            |
|  14  |  11  | 100.00% | 1915.32 |  439.93 | 2080.00 |            unknown            |
|  15  |  11  | 100.00% | 1913.01 |  416.14 | 2088.13 |            unknown            |
|  16  |  11  | 100.00% | 1894.55 |  148.02 | 2143.72 |            unknown            |
|  17  |  11  | 100.00% | 1897.81 |  187.75 | 2087.88 |            unknown            |
|  18  |  11  | 100.00% | 1884.75 |  124.00 | 2075.83 |            unknown            |
|  19  |  11  | 100.00% | 1889.01 |  152.01 | 2075.98 |            unknown            |
|  20  |  11  | 100.00% | 1884.00 |  96.11  | 2131.99 |            unknown            |
|  21  |  11  | 100.00% | 1882.21 |  147.70 | 2068.08 |            unknown            |
|  22  |  11  | 100.00% | 1904.25 |  295.75 | 2072.21 |            unknown            |
|  23  |  11  |  0.00%  |  86.35  |  71.57  |  112.64 |      2001:4860:4860::8888     |
+------+------+---------+---------+---------+---------+-------------------------------+
```

#### UDP

конфигурация:
```json
{
    "algorithm": {
        "target_address": "2001:4860:4860::8888"
    },
    "sender": {
        "l4": "udp",
        "l3": "ipv6"
    }
}
```

результат:
```
+------+------+---------+---------+---------+---------+------------------------------+
| hops | sent |  lost % |  avg ms |  min ms |  max ms |          addresses           |
+------+------+---------+---------+---------+---------+------------------------------+
|  1   |  10  |  0.00%  |  68.60  |  50.00  |  84.05  |      2a02:6b8:0:40c::1       |
|  2   |  10  |  0.00%  |  68.32  |  56.15  |  92.27  |      2a02:6b8:0:475::c1      |
|  3   |  10  |  0.00%  |  70.07  |  51.93  |  100.30 |    2a02:6b8:0:2000::a501     |
|  4   |  10  |  0.00%  |  67.85  |  59.56  |  96.36  |    2a02:6b8:0:3400::deca     |
|  5   |  10  |  0.00%  |  71.30  |  43.69  |  84.18  |     2001:4860:1:1::19e9      |
|  6   |  10  |  20.00% |  468.41 |  55.76  | 2064.07 | 2001:4860:1:1::19e8, unknown |
|  7   |  10  |  0.00%  |  86.77  |  59.43  |  147.96 |     2001:4860:0:1::510f      |
|  8   |  10  |  40.00% |  870.66 |  63.75  | 2067.77 | unknown, 2001:4860:0:116e::2 |
|  9   |  10  |  0.00%  |  83.36  |  67.97  |  104.21 |    2001:4860::c:4002:9189    |
|  10  |  10  |  0.00%  |  83.55  |  60.08  |  108.05 |   2001:4860::cc:4001:16c7    |
|  11  |  10  |  10.00% |  280.73 |  71.93  | 2068.04 | 2001:4860:0:1::2e13, unknown |
|  12  |  10  | 100.00% | 2056.72 | 2040.01 | 2091.91 |           unknown            |
|  13  |  10  | 100.00% | 2056.86 | 2036.08 | 2076.18 |           unknown            |
|  14  |  10  | 100.00% | 2064.09 | 2056.36 | 2072.12 |           unknown            |
|  15  |  10  | 100.00% | 2059.46 | 2043.62 | 2080.18 |           unknown            |
|  16  |  10  | 100.00% | 2061.30 | 2047.88 | 2100.27 |           unknown            |
|  17  |  10  | 100.00% | 2058.34 | 2040.19 | 2075.94 |           unknown            |
|  18  |  10  | 100.00% | 2059.60 | 2039.97 | 2068.45 |           unknown            |
|  19  |  10  | 100.00% | 2058.47 | 2035.72 | 2107.87 |           unknown            |
|  20  |  10  | 100.00% | 2057.51 | 2035.91 | 2072.30 |           unknown            |
|  21  |  10  |  0.00%  |  78.20  |  63.81  |  96.40  |     2001:4860:4860::8888     |
+------+------+---------+---------+---------+---------+------------------------------+
```
